#!/usr/bin/bash

RED='\033[0;31m'
GREEN='\e[32m'
NC='\033[0;0m'

base=$PWD/../../../../
test_name=./$(dirname ${PWD#$(realpath $base)/})

# run simulation
./run.sh >out.log 2>error.log
return_value=$?
set -e

error=$(cat error.log)
error_not_contain="error"

out=$(cat out.log)
out_expected=$(cat <<EOF
start simulation
include found: loading file ./../Array.stm
00000000 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000000 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000001 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000000 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000001 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000002 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
number_of_elements_got 0x08
array: dump 
 0x00 0x01 0x0A 0x02 0x0B 0x7FFFFFFF 0x80000000 0xFFFFFFFF
number_of_elements_got 0x08
array: dump 
 0x01 0x01 0x0A 0x02 0x0B 0x7FFFFFFF 0x80000000 0xFFFFFFFF
number_of_elements_got 0x08
array: dump 
 0x02 0x01 0x0A 0x02 0x0B 0x7FFFFFFF 0x80000000 0xFFFFFFFF
00000000 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000003 00000022 00000033 00000000 12345678 00000777 00000800 00000FFF 
00000001 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000002 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000004 00000022 00000033 00000000 12345678 00000777 00000800 00000FFF 
00000000 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000003 00000022 00000033 00000000 12345678 00000777 00000800 00000FFF 
00000001 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
00000005 00000022 00000033 00000000 12345678 00000777 00000800 00000FFF 
00000002 00000001 0000000A 00000002 0000000B 7FFFFFFF 80000000 FFFFFFFF 
number_of_elements_got 0x08
array: dump 
 0x04 0x22 0x33 0x00 0x12345678 0x0777 0x0800 0x0FFF
number_of_elements_got 0x08
array: dump 
 0x00 0x01 0x0A 0x02 0x0B 0x7FFFFFFF 0x80000000 0xFFFFFFFF
number_of_elements_got 0x08
array: dump 
 0x03 0x22 0x33 0x00 0x12345678 0x0777 0x0800 0x0FFF
number_of_elements_got 0x08
array: dump 
 0x01 0x01 0x0A 0x02 0x0B 0x7FFFFFFF 0x80000000 0xFFFFFFFF
number_of_elements_got 0x08
array: dump 
 0x05 0x22 0x33 0x00 0x12345678 0x0777 0x0800 0x0FFF
number_of_elements_got 0x08
array: dump 
 0x02 0x01 0x0A 0x02 0x0B 0x7FFFFFFF 0x80000000 0xFFFFFFFF
Main test finished
EOF
)

if [[ $return_value == 0 ]] &&
   [[ ! "$error" =~ "$error_not_contain" ]] &&
   [[ "$out" =~ "$out_expected" ]] ; then
    echo -e "$test_name -> ${GREEN}successfull${NC}"
    exit 0
else
    echo -e "$test_name -> ${RED}error${NC}"
    exit 1
fi
